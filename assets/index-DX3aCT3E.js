(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const D="nfc_users",T="nfc_logs";function L(){const e=localStorage.getItem(D);return e?JSON.parse(e):{}}function B(e){localStorage.setItem(D,JSON.stringify(e))}async function P(e){return new Promise(t=>{const o=L()[e];t(o?{id:e,...o}:null)})}async function k(e,t,s,o){return new Promise(n=>{const r=L();r[e]={name:t,position:s,department:o,created_at:new Date().toISOString()},B(r),n({id:e,...r[e]})})}async function H(e){return new Promise(t=>{const s=L();delete s[e],B(s),t()})}async function F(){return new Promise(e=>{const t=L(),s=Object.entries(t).map(([o,n])=>({id:o,...n}));s.sort((o,n)=>new Date(n.created_at)-new Date(o.created_at)),e(s)})}function M(){const e=localStorage.getItem(T);return e?JSON.parse(e):[]}function z(e){localStorage.setItem(T,JSON.stringify(e))}function j(e){return e&&e.action_type==="ENTRY"?"EXIT":"ENTRY"}async function Y(e,t){return new Promise(s=>{const o=M(),n=o.filter(c=>c.user_id===e.id&&c.department===t).sort((c,A)=>new Date(A.timestamp)-new Date(c.timestamp))[0],r=j(n),i={id:Date.now().toString()+Math.random().toString(36).substr(2,5),user_id:e.id,user_snapshot:{name:e.name,position:e.position,department:e.department},department:t,action_type:r,timestamp:new Date().toISOString()};o.push(i),z(o),s(r)})}async function O(e={}){return new Promise(t=>{let s=M();const o=L();if(s=s.map(n=>{const r=o[n.user_id];let i=n.user_snapshot||r||{name:"Unknown",position:"N/A",department:"N/A"};return!r&&n.user_snapshot&&(i={...i,name:`${i.name} (Deleted)`}),{...n,users:i}}),s.sort((n,r)=>new Date(r.timestamp)-new Date(n.timestamp)),e.date){const n=new Date(e.date),r=new Date(e.date);r.setDate(r.getDate()+1),s=s.filter(i=>{const c=new Date(i.timestamp);return c>=n&&c<r})}e.department&&e.department!=="All"&&(s=s.filter(n=>n.department===e.department)),t(s)})}const l=document.getElementById("statusIcon"),N=document.getElementById("log"),g=l.querySelector("svg"),U=document.getElementById("locationSelect"),p=document.getElementById("registerSection"),E=document.getElementById("nameInput"),b=document.getElementById("positionInput"),C=document.getElementById("departmentInput"),u=document.getElementById("saveButton"),x=document.getElementById("cancelButton"),R=document.getElementById("toggleUsersBtn"),d=document.getElementById("userListSection"),_=document.getElementById("toggleHistoryBtn"),m=document.getElementById("historySection"),f=document.getElementById("logsContainer"),J=document.getElementById("dateFilter"),K=document.getElementById("deptFilter"),y=document.getElementById("exportBtn"),q={statusIcon:l,logElement:N,deviceDepartmentSelect:U,registerSection:p,nameInput:E,positionInput:b,departmentInput:C,saveButton:u,cancelButton:x,toggleUsersBtn:R,userListSection:d,toggleHistoryBtn:_,historySection:m,logsContainer:f,exportBtn:y};for(const[e,t]of Object.entries(q))t||console.error(`CRITICAL ERROR: Element '${e}' not found in DOM. The UI may not function correctly. Please refresh the page.`);let S=null,h=!1,v=!1;const G='<path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />',V='<path stroke-linecap="round" stroke-linejoin="round" d="M9.348 14.651a3.75 3.75 0 010-5.303m5.304 0a3.75 3.75 0 010 5.303m-7.425 2.122a6.75 6.75 0 010-9.546m9.546 0a6.75 6.75 0 010 9.546M5.106 18.894c-3.808-3.808-3.808-9.98 0-13.788m13.788 0c3.808 3.808 3.808 9.98 0 13.788M12 12h.008v.008H12V12z" />',W='<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />',X='<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />',Q='<path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm9 5.25h.008v.008H12v-.008z" />';async function I(){const e=await F();if(d.innerHTML="",e.length===0){d.innerHTML="<p style='color: var(--text-muted); padding: 10px;'>No registered users.</p>";return}e.forEach(t=>{const s=document.createElement("div");s.className="list-item",s.innerHTML=`
      <div class="item-main">
        <span class="item-title">${t.name}</span>
        <span class="item-subtitle">${t.position} • ${t.department}</span>
      </div>
      <button class="btn btn-secondary" style="width: auto; padding: 6px 12px; font-size: 0.8rem; border-color: var(--error); color: var(--error);" onclick="window.removeUser('${t.id}')">Remove</button>
    `,d.appendChild(s)})}async function w(){f.innerHTML='<p style="padding:10px;">Loading...</p>';const e=await O();if(f.innerHTML="",e.length===0){f.innerHTML="<p style='color: var(--text-muted); padding: 10px;'>No logs found.</p>";return}e.forEach(t=>{const s=new Date(t.timestamp).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),o=t.users?t.users.name:"Unknown User";t.users&&t.users.position;const n=t.action_type==="ENTRY"?"badge-entry":"badge-exit",r=document.createElement("div");r.className="list-item",r.innerHTML=`
            <div class="item-main">
                <span class="item-title">${o}</span>
                <span class="item-subtitle">${t.department} • ${s}</span>
            </div>
            <div class="item-meta">
                <span class="badge ${n}">${t.action_type}</span>
            </div>
        `,f.appendChild(r)})}window.removeUser=async e=>{confirm("Are you sure you want to remove this user?")&&(await H(e),I())};function a(e,t){N.classList.remove("hidden"),N.innerHTML=t,l.className="status-icon",e==="scanning"?(l.classList.add("scanning"),g.innerHTML=V,p.classList.add("hidden")):e==="success"?(l.classList.add("success"),g.innerHTML=W,navigator.vibrate&&navigator.vibrate(200)):e==="unknown"?(l.classList.add("error"),g.innerHTML=Q,navigator.vibrate&&navigator.vibrate([100,50,100])):e==="error"?(l.classList.add("error"),g.innerHTML=X,navigator.vibrate&&navigator.vibrate([100,50,100])):g.innerHTML=G}async function Z(e){if(v)return;v=!0,S=e,a("scanning","Processing...");const t=await P(e);if(t){const s=U.value,o=await Y(t,s);o?(a("success",`
            Access Granted: <strong>${o}</strong><br>
            <strong style="font-size: 1.2rem; color: var(--primary-color)">${t.name}</strong><br>
            <small>${t.position} - ${t.department}</small>
        `),m.classList.contains("hidden")||w()):a("error","Failed to log access."),p.classList.add("hidden"),setTimeout(()=>{a("scanning","Ready for next card..."),v=!1},2500)}else a("unknown",`Unknown Card<br><small>ID: ${e}</small>`),p.classList.remove("hidden"),E.value="",b.value="",C.value="",E.focus()}async function $(){if(!h){a("scanning","Starting NFC Service...");try{if(!("NDEFReader"in window)){a("error","NFC not supported on this device/browser.");return}const e=new NDEFReader;await e.scan(),h=!0,a("scanning","Ready for next card..."),e.addEventListener("readingerror",()=>{a("error","Read failed. Try again."),setTimeout(()=>{h&&a("scanning","Ready...")},2e3)}),e.addEventListener("reading",({serialNumber:t})=>{console.log("Reading:",t),Z(t)})}catch(e){console.error("Error starting NFC:",e),e.name==="NotAllowedError"||e.name==="SecurityError"?(a("idle","Tap screen to activate System"),document.body.addEventListener("click",async()=>{$()},{once:!0})):a("error","NFC Error: "+e.message),h=!1}}}document.addEventListener("DOMContentLoaded",()=>{$()});u.addEventListener("click",async()=>{const e=E.value.trim(),t=b.value,s=C.value;if(!e||!t||!s){alert("Please fill in all fields (Name, Position, Department)");return}if(!S){alert("No card ID found. Please scan again.");return}u.disabled=!0,u.textContent="Saving...";try{await k(S,e,t,s),a("success",`User Registered!<br><strong>${e}</strong>`),p.classList.add("hidden"),I(),setTimeout(()=>{a("scanning","Ready for next card..."),v=!1},2e3)}catch(o){a("error","Registration failed: "+o.message)}finally{u.disabled=!1,u.textContent="Save User"}});x.addEventListener("click",()=>{p.classList.add("hidden"),a("scanning","Ready for next card..."),v=!1});R.addEventListener("click",()=>{if(d.classList.contains("hidden")&&prompt("Enter Admin PIN:")!=="1234"){alert("Invalid PIN");return}d.classList.toggle("hidden"),m.classList.add("hidden"),d.classList.contains("hidden")||I()});_.addEventListener("click",()=>{if(m.classList.contains("hidden")&&prompt("Enter Admin PIN:")!=="1234"){alert("Invalid PIN");return}m.classList.toggle("hidden"),d.classList.add("hidden"),m.classList.contains("hidden")||w()});J.addEventListener("change",w);K.addEventListener("change",w);y.addEventListener("click",async()=>{y.textContent="Exporting...";const e=await O();if(e.length===0){alert("No logs to export."),y.textContent="Export";return}const t=`data:text/csv;charset=utf-8,Timestamp,Name,Position,Department,Action,Location
`+e.map(n=>{const r=n.users?n.users.name:"Unknown",i=n.users?n.users.position:"N/A",c=n.users?n.users.department:"N/A";return`${n.timestamp},${r},${i},${c},${n.action_type},${n.department}`}).join(`
`),s=encodeURI(t),o=document.createElement("a");o.setAttribute("href",s),o.setAttribute("download","nfc_logs.csv"),document.body.appendChild(o),o.click(),document.body.removeChild(o),y.textContent="Export"});I();
